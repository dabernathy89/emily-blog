name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-cf-pages
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APP_ENV: production
      APP_URL: https://www.everydayaccountsblog.com
      ASSET_URL: ${{ vars.ASSET_URL }}
      STATAMIC_ASSET_URL: ${{ vars.STATAMIC_ASSET_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=full" >> "$GITHUB_OUTPUT"
          else
            bash .github/scripts/detect-changes.sh "${{ github.event.before }}" "${{ github.sha }}"
          fi

      - name: Merge main into cf-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout cf-pages
          git config merge.ours.driver true
          git merge origin/main --no-edit

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, exif, gd, fileinfo, pcntl, sockets
          tools: composer:v2
          coverage: none
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Prepare environment
        run: cp .env.ssg .env

      - name: Generate app key
        run: php artisan key:generate

      - name: Remove deleted articles from snapshot
        if: steps.changes.outputs.mode == 'incremental' && steps.changes.outputs.deleted != ''
        run: |
          for url_path in ${{ steps.changes.outputs.deleted }}; do
            rm -rf "storage/app/static${url_path}"
            echo "Removed: storage/app/static${url_path}"
          done

      - name: Generate static site (incremental)
        if: steps.changes.outputs.mode == 'incremental'
        run: php please ssg:generate --workers=4 ${{ steps.changes.outputs.urls }}

      - name: Generate static site (full)
        if: steps.changes.outputs.mode == 'full'
        run: php please ssg:generate --workers=4

      - name: Commit and push static site
        run: |
          git add storage/app/static/ --force
          if git diff --cached --quiet; then
            echo "No changes to static site"
          else
            git commit -m "Deploy static site $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push origin cf-pages
          fi
